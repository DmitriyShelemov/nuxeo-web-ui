<!--
@license
(C) Copyright Nuxeo Corp. (http://nuxeo.com/)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/nuxeo-elements/nuxeo-document.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-filters-behavior.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-i18n-behavior.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-routing-behavior.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/widgets/nuxeo-select.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/widgets/nuxeo-card.html">
<link rel="import" href="nuxeo-object-diff.html">

<!-- we can just store it locally or install it via npm -->
<script type='text/javascript' src="../../node_modules/jsondiffpatch/dist/jsondiffpatch.umd.js"></script>

<!--
`nuxeo-diff`
@group Nuxeo UI
@element nuxeo-diff
-->
<dom-module id="nuxeo-diff">
  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">
      :host {
        display: block;
        --paper-input-container-underline: {
          display: none;
        };
      }

      :host(:not([unified-view])) .diffPickers {
        @apply --layout-horizontal;
      }

      :host(:not([unified-view])) .diffPicker {
        @apply --layout-flex; /* TODO: not working */
      }

      nuxeo-object-diff[unified] ~ nuxeo-object-diff[unified],
      .side-by-side ~ .side-by-side {
        margin-top: 12px;
      }

      nuxeo-object-diff:not([unified]) {
        @apply --layout-vertical;
        @apply --layout-flex;
      }

      .control ~ .control {
        margin-left: 8px;
      }

      #controls {
        @apply --layout-horizontal;
        @apply --layout-end-justified;
        margin-bottom: 8px;
      }

      #diffContainer {
        @apply --layout-vertical;
      }

      #diffPickerPane {
        @apply --layout-horizontal;
      }

      .diffPickers, #diffPane {
        @apply --layout-vertical;
      }

      .diffPickers {
        @apply --layout-flex;
      }

      .diffPicker {
        @apply --paper-card;
        padding: 4px 4px 4px 8px; /* TODO: styling needed */
      }

      .switchSides {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .switchSides paper-icon-button {
        margin: 0 4px 16px 4px;
      }

      .deltaPane {
        @apply --layout-vertical;
      }

      .side-by-side {
        @apply --layout-horizontal;
      }

      .side-by-side nuxeo-object-diff:not([unified]):not(:first-child) {
        margin-left: 16px;
      }
    </style>

    <nuxeo-resource id="schema"></nuxeo-resource>
    <nuxeo-document id="doc" headers="[[headers]]" enrichers="[[enrichers]]" schemas="[[schemas]]"></nuxeo-document>

    <div id="diffContainer">
      <div id="controls">
        <paper-checkbox class="control" checked="{{showAll}}">[[i18n('diff.controls.showAll')]]</paper-checkbox>
        <template is="dom-if" if="[[_showUnifiedViewCheckbox]]">
          <paper-toggle-button class="control" checked="{{_unifiedView}}">[[i18n('diff.controls.unifiedView')]]</paper-toggle-button>
        </template>
      </div>
      <div id="diffPickerPane">
        <div class="diffPickers">
          <div class="diffPicker">
            <nuxeo-select selected="{{_leftUid}}" attr-for-selected="uid">
              <template is="dom-repeat" items="[[documents]]">
                <paper-item uid="[[item.uid]]">[[_title(item, _hasVersions)]]</paper-item>
              </template>
            </nuxeo-select>
          </div>
          <div class="switchSides" hidden$="[[unifiedView]]">
            <paper-icon-button icon="nuxeo:switch-sides" on-tap="_switchSides" ></paper-icon-button>
          </div>
          <div class="diffPicker">
            <nuxeo-select selected="{{_rightUid}}" attr-for-selected="uid">
              <template is="dom-repeat" items="[[documents]]">
                <paper-item uid="[[item.uid]]">[[_title(item, _hasVersions)]]</paper-item>
              </template>
            </nuxeo-select>
          </div>
        </div>
        <div class="switchSides" hidden$="[[!unifiedView]]">
          <paper-icon-button icon="nuxeo:switch-sides" on-tap="_switchSides" ></paper-icon-button>
        </div>
      </div>
      <div id="diffPane">
        <template is="dom-repeat" items="[[_getCommonSchemas(_schemas, showAll, _delta)]]" as="schema" sort="_sortSchemas">
          <nuxeo-card heading="[[schema.name]]" collapsible opened>
            <div class="deltaPane">
              <template is="dom-repeat" items="[[_getCommonSchemaProperties(schema, showAll, _delta)]]" as=property>
                <!-- unified view -->
                <template is="dom-if" if="[[unifiedView]]">
                  <nuxeo-object-diff property="[[_getPropertyName(schema, property)]]"
                                     label="[[_computeLabel(schema, property)]]"
                                     schema="[[schema]]"
                                     delta="[[_getPropertyDiff(_delta, property)]]"
                                     original-value="[[_getDocumentProperty(property, _left)]]"
                                     new-value="[[_getDocumentProperty(property, _right)]]"
                                     show-all="[[showAll]]"
                                     unified
                                     display-label></nuxeo-object-diff>
                </template>
                <!-- side-by-side view -->
                <template is="dom-if" if="[[!unifiedView]]">
                  <div class="side-by-side">
                    <nuxeo-object-diff property="[[_getPropertyName(schema, property)]]"
                                       label="[[_computeLabel(property)]]"
                                       schema="[[schema]]"
                                       delta="[[_getPropertyDiff(_delta, property)]]"
                                       original-value="[[_getDocumentProperty(property, _left)]]"
                                       new-value="[[_getDocumentProperty(property, _right)]]"
                                       show-all="[[showAll]]"
                                       hide-additions display-label></nuxeo-object-diff>
                    <nuxeo-object-diff property="[[_getPropertyName(schema, property)]]"
                                       schema="[[schema]]"
                                       delta="[[_getPropertyDiff(_delta, property)]]"
                                       original-value="[[_getDocumentProperty(property, _left)]]"
                                       new-value="[[_getDocumentProperty(property, _right)]]"
                                       show-all="[[showAll]]"
                                       hide-deletions display-label></nuxeo-object-diff>
                  </div>
                </template>
              </template>
            </div>
          </nuxeo-card>
        </template>
      </div>
    </div>

  </template>

  <script>
    (function() {
      var _customLoadPromise;
      var typeDataCache = {};
      Polymer({
        is: 'nuxeo-diff',
        behaviors: [Nuxeo.RoutingBehavior, Nuxeo.I18nBehavior, Nuxeo.FiltersBehavior, Polymer.IronResizableBehavior],
        properties: {
          docIds: {
            type: Array,
            value: []
          },
          documents: {
            type: Array,
            value: []
          },
          visible: {
            type: Boolean,
            value: false
          },
          showAll: {
            type: Boolean,
            value: false,
          },
          unifiedView: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            readOnly: true
          },
          /**
           * List of content enrichers passed on to `provider`.
           * Already set by default are thumbnail, permissions and highlight.
           */
          enrichers: {
            type: String
          },
          /**
           * The headers passed on to `provider`.
           * Already set by default are 'X-NXfetch.document': 'properties' and 'X-NXtranslate.directoryEntry': 'label'.
           */
          headers: {
            type: String,
            value: {'X-NXfetch.document': 'properties', 'X-NXtranslate.directoryEntry': 'label'}
          },
          /**
           * The schemas passed on to `provider`.
           **/
          schemas: {
            type: String
          },
          _unifiedView: {
            type: Boolean,
            value: false,
            observer: '_resize'
          },
          _showUnifiedViewCheckbox: Boolean,
          _leftUid: {
            type: String,
            observer: '_leftUidChanged'
          },
          _rightUid: {
            type: String,
            observer: '_rightUidChanged'
          },
          _schemas: Array,
          _left: Object,
          _right: Object,
          _delta: Object,
          _hasVersions: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_docIdsChanged(docIds.*)'
        ],

        listeners: {
          'iron-resize': '_resize'
        },

        created: function() {
          if (!_customLoadPromise) {
            _customLoadPromise = new Promise(function(resolve, reject) {
              this.importHref(this.resolveUrl('imports.html'), resolve, reject);
            }.bind(this));
          }
        },

        _resize: function() {
          if (document.body.offsetWidth <= 720) {
            this._setUnifiedView(true);
            this.set('_showUnifiedViewCheckbox', false);
          } else {
            this._setUnifiedView(this._unifiedView);
            this.set('_showUnifiedViewCheckbox', true);
          }
        },

        _switchSides: function() {
          var left = this._leftUid;
          var right = this._rightUid;
          //this._leftUid = null; // prevent diff with the same id
          this.set('_rightUid', left);
          this.set('_leftUid', right);
        },

        _leftUidChanged: function(newValue, oldValue) {
          if (newValue === this._rightUid) {
            this.set('_rightUid', oldValue);
          } else {
            this.diff();
          }
        },

        _rightUidChanged: function(newValue, oldValue) {
          if (newValue === this._leftUid) {
            this.set('_leftUid', oldValue);
          } else {
            this.diff();
          }
        },

        _computeLabel: function(schema, property) {
          var key = 'diffObject.property.label.' + property;
          var translation = this.i18n(key);
          return key !== translation ? translation : this._getPropertyName(schema, property);
        },

        _title: function(document) {
          return document && (document.title + (this._hasVersions ?
            (' (v' + document.properties['uid:major_version'] + '.' + document.properties['uid:minor_version'] + ')')
            : ''));
        },

        /* DOM-repeat filters and sort functions */

        _filterUid: function(uid) {
          return function(document) {
            return document.uid != uid;
          }
        },

        _sortSchemas: function(schema1, schema2) {
          var schema1properties = this._getCommonProperties(this._left, this._right, schema1, this._delta);
          var schema2properties = this._getCommonProperties(this._left, this._right, schema2, this._delta);
          if ((schema1properties.length === 0 && schema1properties.length === schema2properties.length) ||
              (schema1properties.length > 0 && schema2properties.length > 0))  {
            return schema1.name > schema2.name;
          } else {
            return schema1properties.length < schema2properties.length;
          }
        },

        /* fetchers */

        _sequencer: function(promises) {
          return promises.reduce(function(current, next) {
            return current.then(next);
          }, Promise.resolve([]));
        },

        _docIdsChanged: function() {
          if (this.visible && this.docIds && this.docIds.length > 1) {
            var calls = [];
            this.documents = [];
            this.docIds.forEach(function(uid) {
              calls.push(function() {
                this.$.doc.docId = uid;
                return this.$.doc.get().then(function(response) {
                  this.push('documents', response);
                }.bind(this));
              }.bind(this));
            }.bind(this));
            this._sequencer(calls).then(function() {
              this.set('_hasVersions', this.documents.some(function(doc) {
                return doc.isVersion;
              }));
              this.set('_rightUid', null);
              this.set('_leftUid', this.documents[0].uid);
              this.set('_rightUid', this.documents[1].uid);
            }.bind(this));
          }
        },

        _fetchSchemas: function(document) {
          var type = document.type;
          if (typeDataCache[type]) {
            return Promise.resolve(typeDataCache[type]);
          }
          this.$.schema.path = 'config/types/' + type;
          return this.$.schema.get().then(function(response) {
            typeDataCache[response.name] = response; // cache response
            return response;
          });
        },

        _fetchCommonSchemas: function(left, right) {
          // if both have the same type, only do a single fetch
          if (left && right && left.type === right.type) {
            return this._fetchSchemas(left).then(function(response) {
              return response.schemas;
            });
          }
          return this._fetchSchemas(left).then(function(response1) {
            return this._fetchSchemas(right).then(function(response2) {
              return response1.schemas.filter(function(schema1) {
                return !!response2.schemas.find(function(schema2) {
                  return schema1.name === schema2.name;
                });
              });
            });
          }.bind(this));
        },

        _getCommonProperties: function(left, right, schema, delta) {
          return Object.keys(left.properties).filter(function(leftPropName) {
            return !!Object.keys(right.properties).find(function(rightPropName) {
              return leftPropName === rightPropName &&
                     (schema ? leftPropName.startsWith((schema.prefix ? schema.prefix : schema.name) + ':') : true) &&
                     (delta ? delta[leftPropName] : true);
            });
          });
        },

        _getCommonSchemaProperties: function(schema, showAll, delta) {
          return this._getCommonProperties(this._left, this._right, schema, showAll ? null : delta);
        },

        _getCommonSchemas: function(schemas, showAll) {
          if (!schemas) {
            return;
          }
          return showAll ? schemas : schemas.filter(function(schema) {
            return this._getCommonProperties(this._left, this._right, schema, showAll ? null : this._delta).length > 0;
          }.bind(this));
        },

        /* comparison */

        _getPropertyDiff: function(delta, property) {
          return delta && delta[property];
        },

        _getDocumentProperty: function(property, document) {
          return document.properties[property];
        },

        _getPropertyName: function(schema, property) {
          if (!property || !schema) {
            return;
          }
          return property.replace(new RegExp('^' + (schema.prefix ? schema.prefix : schema.name) + ':'), '');
        },

        _diff: function() {
          if (!this._leftUid || !this._rightUid || this._leftUid === this._rightUid) {
            return;
          }
          this._updateUrl(this._leftUid, this._rightUid);
          var left = this.documents.find(function(doc) {
            return doc.uid === this._leftUid;
          }.bind(this));
          var right = this.documents.find(function(doc) {
            return doc.uid === this._rightUid;
          }.bind(this));
          this.set('_left', left);
          this.set('_right', right);
          this._fetchCommonSchemas(left, right).then(function(schemas) {
            this.set('_schemas', schemas);
            var delta = jsondiffpatch.diff(left.properties, right.properties);
            this._schemas.forEach(function(schema) {
              this._filterDelta(delta, schema);
            }.bind(this));
            this.set('_delta', delta);
          }.bind(this));
        },

        diff: function() {
          _customLoadPromise.then(this._diff.bind(this));
        },

        _updateUrl: function(leftUid, rightUid) {
          var matches = window.location.href.match(/^.*\/#!\/diff/g);
          if (matches.length) {
            var needsReplace = !!window.location.href.match(/^.*\/#!\/diff$/g);
            if (needsReplace) {
              history.replaceState(null, window.title, [matches[0], leftUid, rightUid].join('/'));
            } else {
              var newUrl = [matches[0], leftUid, rightUid].join('/');
              if (newUrl !== window.location.href) {
                history.pushState(null, window.title, [matches[0], leftUid, rightUid].join('/'));
              }
            }
          }
        },

        _filterDelta: function(delta, schema, parentPath) {
          var path = parentPath || '';
          // if it's an array diff
          if (delta['_t'] && delta['_t'] == 'a') {
            Object.keys(delta).filter(function(key) {
              return key !== '_t';
            }).forEach(function(key) {
              var subpath = path ? [path, key].join('.') : properties[i];
              var deltaObj = (Array.isArray(delta[key]) && delta[key].length > 0) ? delta[key][0] : delta[key];
              this._filterDelta(deltaObj, schema, subpath);
              if (Object.keys(delta[key]).length === 0) {
                delete delta[key];
              }
            }.bind(this));
          } else {
            var deltaObj = (Array.isArray(delta) && delta.length > 0) ? delta[0] : delta;
            var properties = parentPath ? Object.keys(deltaObj) : this._getCommonSchemaProperties(schema, false, deltaObj);
            for (var i = 0; i < properties.length; i++) {
              var key = properties[i];
              var subpath = path ? [path, key].join('.') : properties[i];
              var type;
              var subSchema;
              if (typeof schema === 'string') {
                type = schema.replace(/\[\]$/, '');
              } else {
                subSchema = schema.fields[this._getPropertyName(schema, key)];
                type = subSchema.type || subSchema;
              }
              // TODO: pluggability
              switch (type) {
                case 'string':
                case 'date':
                case 'long':
                case 'integer':
                case 'boolean':
                case 'double':
                  break;
                case 'blob':
                  if (!deltaObj[key].digest) {
                    delete deltaObj[key];
                  }
                  break;
                default:
                  if (deltaObj) {
                    this._filterDelta(deltaObj[key], subSchema, subpath, schema);
                  }
                  break;
              }
            }
          }
        }

      });
    })();
  </script>

</dom-module>
